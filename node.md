
# GEO Network Client documentation
<br/>
<br/>

# How to run
### Installation
1. Download/Build last node version from the [repo](https://github.com/GEO-Protocol/GEO-network-client); <br/>
You can follow the links provided in [releases changelogs](https://github.com/GEO-Protocol/GEO-network-client/blob/develop/RELEASES.md) to get desired version of the node build (currently, only BETA1 is available).

1. Move `geo_network_client` to the desired FS location. <br/>
The default location for the node in `~/node/`, but you are free to chose any other location. <br/>
If you are using provided [WM image](https://github.com/GEO-Protocol/GEO-network-client/blob/develop/RELEASES.md#beta-1) (or docker container) - it is already configured. No need to go through this step.


1. Prepeare the configuration. <br/>
Please, follow instructions from a section "Configuration".

1. Start the node: `./geo_network_client` <br/>
In case of successfull fly node should report
* core and required subsystems initialisation messages;
* current observers chain height.

![node_run.png](https://github.com/GEO-Protocol/Documentation/blob/master/resources/node_run.png)

In case if node was not started as expected - please, refer to the `operations.log`. 
Usually it contains some details abot the error occured. 

After the first launch of the node, the following objects appear in the node’s directory:
* The `io` directory, that contains two files: `storageDB` and `communicatorStorageDB`. 
This two files stores all the node’s data: trustlines, keys, history, payments, routing tables, etc.
* The `fifo` directory, that contains three files: `commands.fifo`, `results.fifo` and `events.fifo`. The node’s communication will happen through these files. 
* The `operations.log` file containing detailed log of network actions (still needs some polishing).
* The `process.pid` file containing the `PID` of the runnig node.
<br/>
<br/>

### Libraries required
GEO Network Client uses `boost` libraries and `libsodium` for the cryptography. </br> 
Please, enshure presense of this libraries in you env. before starting the node.
<br/>
<br/>

### Configuration
Configuration contains network interfaces that should be used by the node and reported to the rest of the network, 
as well as addresses of the observers, that are expected to be present in the network.

**Note: Beta 1 release supports only static, publicly available IPv4 addresses.** <br/>
So, in case if you are planning to try to launch several nodes and perform some operations between them, - 
please, ensure, that all of them would be able to communicate to each other via `UDP/IPv4` interface.

**Note: Beta 1 release supports only statically listed observers list** <br/>
The protocol itself is expected to support dynamically formed observers list, provided by the GSR [#todo link to GSR description].
</br>
</br>

Configuration file is named `conf.json`. <br/> 
It is required to be located **on the same FS level** as `geo_network_client`. </br>
![node_settings_fs_level.png](https://github.com/GEO-Protocol/Documentation/blob/master/resources/node_settings_fs_level.png)


The configuration file must contain addresses information of the node – `addresses`: 
all the addresses that identify the node (including ports, if related) and their types, as well as the list of the [Observers](https://github.com/GEO-Protocol/Observer) – `observers`. <br/>
<br/>
In the current version of the node only one type of addressing is supported – ipv4.<br/>
</br>
Currently, observers test. net is driven by only 4 observers. 
It is fully enough for providing all necessary operations for the GEO nodes and the GEO Network Test net.
At the moment, **observers do not check validity of the TSLs/Claims generated by the GEO Nodes**, 
so this network is not suitable for production usage, but is able to provide observing functionality that fully covers BETA1 release needs. The production environment is expected to be driven by the 1024+ observers. 

_Configuration for the BETA1 test net:_
```
{
  "addresses":
  [
    {
      "type":"ipv4",
      "address":"127.0.0.1:2000"
    }
  ],
	"observers":
  [
    {
      "address":"68.183.146.232:4000",
      "type":"ipv4"
    },													
    {
      "address":"46.101.51.158:4000",
      "type":"ipv4"
    },
    {
      "address":"206.189.84.116:4000",
      "type":"ipv4"
    },
    {
      "address":"159.89.115.33:4000",
      "type":"ipv4"
    }
  ]
}
```
</br>
The node’s addresses will be used to identify the node and they will be stored at other nodes with which the current node will communicate in either way: opening a trustline – TL, making payments, etc. Therefore, changing the address of the node after it has already opened some TLs will lead to incorrect work with the corresponding nodes.


</br>
</br>

# How to use the node
Here we will describe several ways possible how to communicate with the node. <br/>
For the simplicity reasons, the documentation is provided in format of tutorial.

## Basic overview
Node represents _an account_ in GEO Network. <br/>
_It is assumed, each one participant of the GEO Network would access the network via it's own node_. <br/>
In contrast to some other decentralized networks, GEO Network does not delegate calculations to the miners, 
but assumes network participants would take part (only) in transactions, in which them are involved.

GEO Network Client implements such a node and provides low-level API 
for operations processing: assets transfers, trust-lines/channels accounting, etc.
</br>
</br>
For the simplicity reasons, in this tutorial we would use provided WM image. 
You can find the latest images with latest node build in [GEO Network Client repo](https://github.com/GEO-Protocol/GEO-network-client) ("Releases" section of the description).
<br/>

## VirtualBox configuration
We would need SSH session to manipulate the nodes, so the WM should accept incoming TCP connections. <br/>
The simples way to achieve it is to configure NAT Ports Forwarding for the destination WM.

<p align="center">
<img src="https://github.com/GEO-Protocol/Documentation/blob/master/resources/wm_network_settings_1.png">
	VirtualBox Network Adapter Settings
</p>
<br/>
<br/>

<p align="center">
<img src="https://github.com/GEO-Protocol/Documentation/blob/master/resources/wm_network_settings_2.png">
	Pord Forwarding Settings
</p>
<br/>
<br/>


## Network topology
In this tutorial we would use 3 nodes: `node1`, `node2`, `node3`. <br/>
We used WM image, and copied `node` dir 3 times:

1. `cd ~`
1. `cp ./node ./node1 -r`
1. `cp ./node ./node2 -r`
1. `cp ./node ./node3 -r`

We would use one WM to run all three nodes. You can follow this tutorial in the same way, or you can launch 3 different WMs and configure appropriate network layer so all the WMs would be able to communicate to each other WM.

Each one node needs one SSH session to be launched in, and one more SSH session for the commands transferring and results fetching. So in total, we are opening 6 SSH sessions to the WM.

<p align="center">
<img src="https://github.com/GEO-Protocol/Documentation/blob/master/resources/ssh_1.png">
	SSH into the WM
</p>
<br/>
<br/>

```
User: geo
Pass: geo
```

Then, we need to launch the nodes. <br/>
For it to be done, follow the next steps:

1. Sitch to `node1` SSH sesssion and do: `cd ~/node1/ && ./geo_network_client`
1. Sitch to `node2` SSH sesssion and do: `cd ~/node2/ && ./geo_network_client`
1. Sitch to `node3` SSH sesssion and do: `cd ~/node3/ && ./geo_network_client`

Please, refer to the "How to run" section of this doc for the details about how node could be started and what behaviour of it to expect in various cases.


## Node communication
There are 3 possible ways to communicate to the GEO node:
1. **Via low-level GEO Node protocol** <br/>
This is the most performant and the most flexible way of communication, but in the same time, the most complex one.
This communication channel should be used in production environments or embedded systems 
with maximum performance in mind, and to avoid addtional resource consupting layers of communication (for example, HTTP API).

1. **Via command-line interface** [comming soon] <br/> 
This interface provides ability to communicate with node from the console in mode "one command at a time". </br>
It is useful during development, but it should not be considered to be used in production environments, 
due to the limitations of concurent commands processing, and relatively high resouce usage per command execution.

1. **Via JSON API** [comming soon] <br/>
This interface provides ability to communicate with node via HTTP API and to process more than one command at a time. 
It is useful during development, and also might be considered to be used in production environments, 
that are configured for communication with only one, or several nodes.


# Low-level GEO Node protocol
## Overview
All commands have to be transferred to the `commands.fifo` pipe. 
The node at the start opens this file for reading immediately, so once a command gets there, it will be processed at once.
<br/>
The results of the command execution will be written by the node into the `results.fifo` pipe. This file must be opened for reading **before the start of the node**, otherwise the node will freeze at the first attempt to write a result. Since we do not have the `results.fifo` pipe (as well as other files) initially, we have to run the node first to form all these files. Then we have to stop it, and all the next times we will have to open the `results.fifo` file for reading before the node start.<br/>
<br/>
The `events.fifo` file is planned for recording the node’s internal events (incoming payments, opening an outgoing TL, etc.). But this functionality is not implemented yet, so this file can be ignored so far.

All commands and results consist of plain text data separated by the tab symbol `\t`, and ends with the end of the line symbol `\n`. The command and the result start with a 16-byte `command UUID` (UUID4 hex representation) that should be generated by the command issuer.

Each command consist of `command UUID`, command name, and comamnd arguments.

# How to read command results
1. Move to the node directory: `cd ~/node` </br>
1. Open `./fifo/results.fifo` for reading. It is a linux-pipe (fifo-file), so it would not open, untile the node is not launched as well (pipe opens in read mode only if there is another process that has opened it for the writing). <br/> 
`cat ./fifo/results.fifo` </br>
In this case, `cat` would hang, until node would be launched and some command-results would be written.

1. Start the node: `./geo_network_client` </br>
</br>
</br>

# Opening a Trust Line
`INIT:contractors/trust-line`

|Argument|Description
|---|---|
|Number of contractor’s addresses| How many addresses of the contractor would be included into the cpmmand|
|Vector of addresses of the contractor| Vector of pairs `(address type; address)`. As was mentioned above, the node currently supports only one type of address: `IPv4`, and its type code is `12`|
| Equivalent ID | ID if the [equivalent](https://github.com/GEO-Protocol/specs-protocol/blob/master/trust_lines/trust_lines.md#trust-lines-equivalents) in which TL (Trust Line) should be opened: an integer greater than 0. |

### Example
`13e5cf8c-5834-4e52-b65b-f9281dd1ff91\tINIT:contractors/trust-line\t1\t12\t127.0.0.1:2002\t1\n`
